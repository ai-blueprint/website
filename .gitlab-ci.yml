variables:
  GIT_CONFIG_COUNT: "1"
  GIT_CONFIG_KEY_0: "http.version"
  GIT_CONFIG_VALUE_0: "HTTP/1.1"
  GIT_SSL_NO_VERIFY: "true"

stages: [build, deploy]

build-job:
  stage: build
  tags: [windows]
  script:
    - yarn install
    - yarn generate
    - if (!(Test-Path .output/public)) { Write-Host "[ERROR] .output/public missing"; exit 1 }
    - if (Test-Path website) { Remove-Item website -Recurse -Force }
    - Move-Item .output/public website
    - if (!(Test-Path website)) { Write-Host "[ERROR] website creation failed"; exit 1 }
  artifacts:
    paths: [website/]
    expire_in: 1 hour

deploy-job:
  stage: deploy
  tags: [windows]
  before_script:
    - |
      if (-not $env:FTP_HOST -or -not $env:FTP_USER -or -not $env:FTP_PASS) {
        Write-Error "Missing required FTP environment variables"
        exit 1
      }
  script:
    - |  
      function Add-FtpFile {  
        param($ftpFilePath, $localFile, $username, $password) {  
          $ftprequest = [System.Net.FtpWebRequest]::Create($ftpFilePath)  
          $ftprequest.Credentials = New-Object System.Net.NetworkCredential($username, $password)  
          $ftprequest.Method = [System.Net.WebRequestMethods+Ftp]::UploadFile  
          $content = [System.IO.File]::ReadAllBytes($localFile)  
          $ftprequest.ContentLength = $content.Length  
          $rs = $ftprequest.GetRequestStream()  
          $rs.Write($content, 0, $content.Length)  
          $rs.Close()  
          $rs.Dispose()  
        }  
      }  

      function Add-FtpDirectory {  
        param($ftpPath, $username, $password) {  
          $ftprequest = [System.Net.FtpWebRequest]::Create($ftpPath)  
          $ftprequest.Credentials = New-Object System.Net.NetworkCredential($username, $password)  
          $ftprequest.Method = [System.Net.WebRequestMethods+Ftp]::MakeDirectory  
          try { $ftprequest.GetResponse() | Out-Null } catch {}  # 已存在忽略  
        }  
      }  

      function Add-FtpFolderWithFiles {  
        param($sourceFolder, $destinationFolder, $username, $password) {  
          Add-FtpDirectory $destinationFolder $username $password  
          $files = Get-ChildItem $sourceFolder -File  
          foreach($file in $files) {  
            $uploadUrl = "$destinationFolder/$($file.Name)"  
            Add-FtpFile $uploadUrl $file.FullName $username $password  
          }  
        }  
      }  

      function Add-FtpFolderWithFilesRecursive {  
        param($sourceFolder, $destinationFolder, $username, $password) {  
          Add-FtpFolderWithFiles $sourceFolder $destinationFolder $username $password  
          $subDirs = Get-ChildItem $sourceFolder -Directory  
          $fromUri = New-Object System.Uri($sourceFolder)  
          foreach($subDir in $subDirs) {  
            $toUri = New-Object System.Uri($subDir.FullName)  
            $relativeUrl = $fromUri.MakeRelativeUri($toUri)  
            $relativePath = [System.Uri]::UnescapeDataString($relativeUrl.ToString())  
            $lastFolder = $relativePath.Substring($relativePath.LastIndexOf("/") + 1)  
            Add-FtpFolderWithFilesRecursive $subDir.FullName "$destinationFolder/$lastFolder" $username $password  
          }  
        }  
      }  

      $ftpUri = "ftp://$env:FTP_HOST/$env:REMOTE_DIR"  
      Add-FtpFolderWithFilesRecursive "website/" $ftpUri $env:FTP_USER $env:FTP_PASS
